stages:
  - deploy

deploy:
  stage: deploy
  image: alpine
  before_script:
    - apk update && apk add openssh git nodejs npm
  script:
    # Táº¡o SSH key Ä‘á»ƒ káº¿t ná»‘i vÃ o server
    - echo "$SSH_PRIVATE_KEY" > id_rsa
    - chmod 600 id_rsa
    - mkdir -p ~/.ssh
    - mv id_rsa ~/.ssh/id_rsa

    # SSH vÃ o server Ä‘á»ƒ deploy
    - ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
        cd /root/HelloJob/quanlychitieu &&

        echo 'ğŸ“¥ Pull code tá»« GitLab...' &&
        git pull origin main &&

        echo 'ğŸ“¦ CÃ i Ä‘áº·t dependencies...' &&
        npm install &&

        echo 'ğŸ—ï¸ Build project...' &&
        npm run build &&

        echo 'ğŸ” Restart báº±ng screen...' &&
        screen -S cicd -X quit || true &&
        screen -dmS cicd npm start
      "
